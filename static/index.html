<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文档解析服务</title>
  <style>
    :root{--prim:#1677ff}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#f7f8fa;color:#222;display:flex;justify-content:center}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.08);width:640px;margin:48px 16px;padding:48px}
    h1{font-size:32px;margin:0 0 36px}
    .sec{margin-bottom:32px}
    .sec-title{font-size:20px;font-weight:600;margin-bottom:16px}
    input[type=file]{display:none}
    .file-box{border:2px dashed #bbb;border-radius:8px;padding:32px;text-align:center;font-size:18px;cursor:pointer;transition:.25s}
    .file-box:hover{border-color:var(--prim);background:#fafbfc}
    .check-grid{display:flex;flex-wrap:wrap;gap:20px}
    .check-item{display:flex;align-items:center;font-size:18px;gap:10px}
    .check-item input{width:20px;height:20px;accent-color:var(--prim)}
    button{padding:14px 36px;font-size:18px;border:none;border-radius:6px;background:var(--prim);color:#fff;cursor:pointer}
    button:disabled{background:#94bfff;cursor:not-allowed}
    #msg{margin-top:24px;font-size:18px}
    .err{color:#e04040}
    .ok{color:#0bb750}
  </style>
</head>
<body>
  <div class="card">
    <h1>文档解析服务</h1>

    <!-- 文件 -->
    <div class="sec">
      <input id="fileInput" type="file" />
      <div id="fileBox" class="file-box">点击或拖拽上传文件</div>
    </div>

    <!-- VLM 开关 -->
    <div class="sec">
      <div class="sec-title">VLM 版面识别</div>
      <label class="check-item">
        <input id="vlm_enable" type="checkbox" checked />
        <span>启用</span>
      </label>
    </div>

    <!-- 图片处理多选 -->
    <div class="sec">
      <div class="sec-title">图片处理（可多选）</div>
      <div class="check-grid">
        <label class="check-item"><input type="checkbox" value="class" name="img">class</label>
        <label class="check-item"><input type="checkbox" value="description" name="img">description</label>
        <label class="check-item"><input type="checkbox" value="html" name="img">html</label>
      </div>
    </div>

    <!-- 表格处理多选 -->
    <div class="sec">
      <div class="sec-title">表格处理（可多选）</div>
      <div class="check-grid">
        <label class="check-item"><input type="checkbox" value="key-value" name="table">key-value</label>
        <label class="check-item"><input type="checkbox" value="description" name="table">description</label>
        <label class="check-item"><input type="checkbox" value="html" name="table">html</label>
      </div>
    </div>

    <!-- 提交 -->
    <div class="sec">
      <button id="submitBtn">开始处理</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
const $  = id => document.getElementById(id);
const fileInput = $('fileInput');
const fileBox   = $('fileBox');
const submitBtn = $('submitBtn');
const msgBox    = $('msg');

/* 文件拖放 / 点击 */
fileBox.addEventListener('click', () => fileInput.click());
fileBox.addEventListener('dragover', e => { e.preventDefault(); fileBox.style.borderColor='var(--prim)'; });
fileBox.addEventListener('dragleave', () => { fileBox.style.borderColor='#bbb'; });
fileBox.addEventListener('drop', e => {
  e.preventDefault();
  fileBox.style.borderColor='#bbb';
  if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
  showFile();
});
fileInput.addEventListener('change', showFile);

function showFile(){
  const name = fileInput.files[0]?.name || '';
  fileBox.textContent = name || '点击或拖拽上传文件';
}

/* 提交 */
submitBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if(!file) return flash('请先选择文件','err');

  submitBtn.disabled = true;
  flash('正在处理，请稍候…','ok');

  const fd = new FormData();
  fd.append('file', file);
  fd.append('vlm_enable', $('vlm_enable').checked);

  /* 收集 img 选项 */
  document.querySelectorAll('input[name="img"]:checked')
          .forEach(ch => fd.append('img_select', ch.value));

  /* 收集 table 选项 */
  document.querySelectorAll('input[name="table"]:checked')
          .forEach(ch => fd.append('table_select', ch.value));

  try {
    const r = await fetch('/api/preprocessv4', { method:'POST', body:fd });
    if(!r.ok) throw new Error(await r.text());
    const blob = await r.blob();
    const fname = r.headers.get('Content-Disposition')?.split('filename*=')[1]?.replace("utf-8''",'')
               || 'result.zip';
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = decodeURIComponent(fname); a.click();
    URL.revokeObjectURL(url);
    flash('处理完成，已下载结果包','ok');
  } catch(e) {
    flash('处理失败：'+e.message,'err');
  } finally {
    submitBtn.disabled = false;
  }
});

function flash(text, type){
  msgBox.textContent = text;
  msgBox.className = type;
}
</script>
</body>
</html>