<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文档解析服务</title>
  <style>
    :root{--prim:#1677ff}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#f7f8fa;color:#222;display:flex;justify-content:center}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.08);width:640px;margin:48px 16px;padding:48px}
    h1{font-size:32px;margin:0 0 36px}
    .sec{margin-bottom:32px}
    .sec-title{font-size:20px;font-weight:600;margin-bottom:16px}
    input[type=file]{display:none}
    .file-box{border:2px dashed #bbb;border-radius:8px;padding:32px;text-align:center;font-size:18px;cursor:pointer;transition:.25s}
    .file-box:hover{border-color:var(--prim);background:#fafbfc}
    .check-grid{display:flex;flex-wrap:wrap;gap:20px}
    .check-item{display:flex;align-items:center;font-size:18px;gap:10px}
    .check-item input{width:20px;height:20px;accent-color:var(--prim)}
    button{padding:14px 36px;font-size:18px;border:none;border-radius:6px;background:var(--prim);color:#fff;cursor:pointer}
    button:disabled{background:#94bfff;cursor:not-allowed}
    #msg{margin-top:24px;font-size:18px; word-break: break-all; white-space: pre-wrap;} /* 增加样式以显示JSON */
    .err{color:#e04040}
    .ok{color:#0bb750}
  </style>
</head>
<body>
  <div class="card">
    <h1>文档解析服务</h1>

    <div class="sec">
      <input id="fileInput" type="file" />
      <div id="fileBox" class="file-box">点击或拖拽上传文件</div>
    </div>

    <div class="sec">
      <div class="sec-title">VLM 版面识别</div>
      <label class="check-item">
        <input id="vlm_enable" type="checkbox" checked />
        <span>启用</span>
      </label>
    </div>

    <div class="sec">
      <div class="sec-title">返回格式</div>
      <div class="check-grid">
        <label class="check-item">
          <input type="radio" name="res_type" value="zip" checked />
          <span>结果压缩包 (Zip)</span>
        </label>
        <label class="check-item">
          <input type="radio" name="res_type" value="json" />
          <span>纯数据结果 (JSON)</span>
        </label>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title">图片处理（可多选）</div>
      <div class="check-grid">
        <label class="check-item"><input type="checkbox" value="class" name="img" checked>class</label>
        <label class="check-item"><input type="checkbox" value="description" name="img" checked>description</label>
        <label class="check-item"><input type="checkbox" value="html" name="img" checked>html</label>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title">表格处理（可多选）</div>
      <div class="check-grid">
        <label class="check-item"><input type="checkbox" value="key-value" name="table" checked>key-value</label>
        <label class="check-item"><input type="checkbox" value="description" name="table" checked>description</label>
        <label class="check-item"><input type="checkbox" value="html" name="table" checked>html</label>
      </div>
    </div>

    <div class="sec">
      <button id="submitBtn">开始处理</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
const $  = id => document.getElementById(id);
const fileInput = $('fileInput');
const fileBox   = $('fileBox');
const submitBtn = $('submitBtn');
const msgBox    = $('msg');

/* 文件拖放 / 点击 */
fileBox.addEventListener('click', () => fileInput.click());
fileBox.addEventListener('dragover', e => { e.preventDefault(); fileBox.style.borderColor='var(--prim)'; });
fileBox.addEventListener('dragleave', () => { fileBox.style.borderColor='#bbb'; });
fileBox.addEventListener('drop', e => {
  e.preventDefault();
  fileBox.style.borderColor='#bbb';
  if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
  showFile();
});
fileInput.addEventListener('change', showFile);

function showFile(){
  const name = fileInput.files[0]?.name || '';
  fileBox.textContent = name || '点击或拖拽上传文件';
}

/* 提交 */
submitBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if(!file) return flash('请先选择文件','err');

  submitBtn.disabled = true;
  flash('正在处理，请稍候…','ok');

  const fd = new FormData();
  fd.append('file', file);
  fd.append('vlm_enable', $('vlm_enable').checked);
  
  // 新增：获取 response_type 值
  const resType = document.querySelector('input[name="res_type"]:checked').value;
  fd.append('response_type', resType);

  /* 收集 img 选项 */
  document.querySelectorAll('input[name="img"]:checked')
          .forEach(ch => fd.append('img_select', ch.value));

  /* 收集 table 选项 */
  document.querySelectorAll('input[name="table"]:checked')
          .forEach(ch => fd.append('table_select', ch.value));

  try {
    const r = await fetch('/api/preprocessv4', { method:'POST', body:fd });
    if(!r.ok) throw new Error(await r.text());

    // 根据返回类型处理结果
    if (resType === 'json') {
      const data = await r.json();
      console.log('JSON Result:', data);
      flash('处理完成，数据已打印至控制台并在下方显示：\n\n' + JSON.stringify(data, null, 2), 'ok');
    } else {
      const blob = await r.blob();
      const rawFname = r.headers.get('Content-Disposition');
      let fname = 'result.zip';
      
      // 这里的解析逻辑匹配后端的 quote(file_name) 格式
      if (rawFname && rawFname.includes("filename*=utf-8''")) {
        fname = decodeURIComponent(rawFname.split("filename*=utf-8''")[1]);
      }

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fname; a.click();
      URL.revokeObjectURL(url);
      flash('处理完成，已下载结果包','ok');
    }
  } catch(e) {
    flash('处理失败：' + e.message, 'err');
  } finally {
    submitBtn.disabled = false;
  }
});

function flash(text, type){
  msgBox.textContent = text;
  msgBox.className = type;
}
</script>
</body>
</html>